# 子平真君 (Ziping Zhenjun) AI 命理分析应用 PRD

## 1. 项目概述
**子平真君**是一款基于《渊海子平》经典理论，结合现代 AI Agent（LangGraph）与高精度命理计算引擎（bazi）构建的专业级命理分析应用。通过“计算与分析分离”的架构，为用户提供科学排盘、AI 交互式诊断及古籍辅助决策服务。

## 2. 功能需求

### 2.1 用户认证与基础安全
*   **认证逻辑**：
    *   仅支持邮箱注册/登录。
    *   流程：用户输入邮箱 -> 后端通过 SMTP 发送 6 位数字验证码 -> 用户校验登录 -> 发放 JWT Token。
    *   **安全说明**：当前阶段不强制要求图形验证码（CAPTCHA），但在后端需实现基于 IP 和邮箱的速率限制（Rate Limiting）。
*   **个人信息**：支持修改昵称、头像（提供默认头像库或支持上传）。

### 2.2 多档案管理 (Archive)
*   **核心逻辑**：用户必须先创建档案才能发起 AI 咨询。
*   **字段定义 (严格对齐 BaziRequest)**：
    *   **身份信息**：姓名、性别（男 1/女 0）、与主账号关系标记（自己、配偶、父母等）。
    *   **出生数据**：历法类型（公历/农历）、生辰时刻（使用时间选择器，精确到秒：YYYY-MM-DD HH:MM:SS）。
    *   **地理位置**：出生地选择器（需获取 `latlng.json` 中的经纬度，用于真太阳时计算）。
    *   **算法偏好设置**：
        *   时间模式：真太阳时 (默认) / 平太阳时。
        *   定月模式：节气定月 (默认) / 农历月定月。
        *   子时模式：晚子时不换日 (默认) / 23 点换日。
*   **配置实时生效性**：若用户在“档案页”修改了算法偏好，**已关联的 AI 会话必须立即感知**。在下一轮对话时，Agent 会检测到档案配置版本变化，重新调用 `bazi` 引擎生成最新的排盘 JSON 并更新 AI 上下文。

### 2.3 核心排盘展示 (Bazi Tab)
*   **展示策略**：排盘页作为一级 Tab。进入时默认展示“当前活跃会话”绑定的档案数据；若无会话，则展示用户标记为“自己”的档案。**注意：用户在排盘页手动切换档案仅改变当前展示视图，不影响正在进行的咨询会话绑定关系。**
*   **可视化模块 (对齐 BaziResult)**：
    *   **四柱核心区**：展示年、月、日、时四柱干支、对应十神、纳音五行及旬空状态。
    *   **能量与格局区**：五行能量评分（金木水火土）柱状图、五行气数状态（旺相休囚死）、判定出的格局名称（如“阳刃格”）。
    *   **运程区 (交互重点)**：
        *   **钻取逻辑**：采用 **“点击流年展开流月”** 的交互方式。初始展示大运及流年列表，点击某一流年后，下方滑动展开或弹窗展示该年的 12 个流月干支及运势标记。
    *   **辅助区**：专业神煞（天乙贵人等）、十二长生状态、三元（胎元/命宫/身宫）。

### 2.4 AI 咨询系统 (AI Agent)
*   **计算与分析分离 (Core Principle)**：
    *   **计算引擎 (bazi)**：负责历法转换、干支推导、能量量化、格局判定等硬逻辑计算。LLM 严禁进行任何数字或干支推导计算。
    *   **分析引擎 (LLM)**：负责意图识别、RAG 知识整合、语义理解及结果转述。
*   **会话与档案绑定**：**会话与档案为 1:1 强绑定关系**。新建会话时选择档案，会话生命周期内不可更换档案。
*   **分层记忆架构**：
    1.  **第一层：永存核心态 (Pinned State)**：四柱、格局、喜用等核心 JSON 数据在每轮对话中强制置顶注入 System Prompt，利用 **Prompt Caching** 降费提速。
    2.  **第二层：实时时间感知 (Temporal Awareness)**：每轮对话注入服务器当前时刻（Asia/Shanghai），解决年龄计算及流年定位的“时差”问题。
    3.  **第三层：短期记忆 (Sliding Window)**：保留用户设置的 N 轮（默认 10 条）原始对话。超出部分由 AI 生成摘要。
    4.  **第四层：长期事实记忆 (Fact Memory)**：AI 提取关于特定档案的事实（如“用户目前在上海工作”、“2023 年结婚”），**关联 archive_id 存入 pgvector**。
*   **意图识别**：自动判断用户咨询维度（财运/事业/感情/健康等），动态切换分析侧重点。
    *   **回答模式 (Response Mode)**：
        *   **普通模式**：AI 使用通俗易懂的现代语言进行分析，减少生僻命理术语的直接堆砌，侧重于给出行动建议和心理疏导。
        *   **专业模式**：AI 会深入结合 `bazi` 引擎输出的干支关系、能量评分、格局精解进行详尽推演。分析中会保留适量的专业术语，并大幅增加对《渊海子平》等古籍原文的引用与深度解读。
    *   **交互式诊断 (Interactive Diagnosis)**：当用户问事业等宏观问题时， AI 发现上下文缺乏后天背景（职业、学历等），会主动发起询问引导用户补充，而非盲目给出先天断语。

## 3. 前端页面结构 (Bottom Navigation)

1.  **咨询 (Chat)**：
    *   会话历史列表（左滑置顶/删除）。
    *   流式对话窗口（Markdown 渲染、古籍原文引用标注、档案状态角标）。
2.  **排盘 (Bazi)**：
    *   **档案切换**：页面顶部提供快速切换组件，允许用户在不同档案间自由切换排盘视图。
    *   全量排盘数据展示。
    *   流年/流月交互钻取。
3.  **我的 (Settings)**：
    *   **个人资料 (Profile Header)**：
        *   **展示**：显眼位置展示当前用户头像（圆形）与昵称。
        *   **交互**：右侧或下方提供“编辑资料”按钮，点击进入详情页修改昵称及更换头像。
    *   **系统设置 (持久化存储)**：
        *   **对话深度设置**：用户可自定义“最近 N 轮对话”的 N 值。
        *   **回答模式切换**：支持在“普通”与“专业”模式间切换，影响 AI 的话术风格与深度。
    *   **档案管理 (Archive)**：
        *   档案列表展示与检索。
        *   档案编辑详情页（含算法配置、基本信息修改）。
    *   **记忆管理**：展示 AI 为当前档案记录的所有“事实记忆”列表，支持用户手动删除错误事实。
    *   **关于我们**。

## 4. 技术选型与部署

*   **前端**：React + TypeScript + Material Design + Tailwind CSS。
*   **后端**：FastAPI (Python 3.10+)。
*   **AI 框架**：LangGraph + LangChain。
*   **大模型**：DeepSeek-V3 (推理) / R1 (深度思考)。
*   **向量模型**：BAAI/bge-m3 1024维 (SiliconFlow)。
*   **存储**：
    *   PostgreSQL：存储用户、档案、会话、消息。
    *   pgvector：存储 RAG 古籍向量及事实记忆向量。
    *   Redis：存储验证码、Rate Limit 及分级缓存。
*   **部署**：Docker Compose 容器化部署，阿里云 ECS。

## 5. 数据模型设计 (核心)
*   **User**: `id, email, hashed_password, settings(json: {depth, mode})`
*   **Archive**: `id, user_id, name, gender, birth_time, lat, lng, is_self(bool), algorithms_config(json)`
*   **Session**: `id, user_id, archive_id, title, last_summary`
*   **Message**: `id, session_id, role, content, metadata(json: citations)`
*   **MemoryFact**: `id, archive_id, content, vector, created_at`
