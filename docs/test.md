# 子平真君 AI 全链路验收测试方案 (修订版)

此方案旨在验证全栈功能的完整性、算法的专业深度以及系统的健壮性。

---

## 1. 前端功能矩阵与覆盖验证 (Frontend Feature Matrix)

本节列出前端所有已实现的原子功能，确保 UI/UX 测试无死角。

### 1.1 认证模块 (Auth)
- [x] **登录流**：邮箱校验 -> 验证码发送 -> 倒计时/重发校验 -> JWT 接收与本地持久化。 (Done: 2026-01-09)
- [x] **异常处理**：非法邮箱格式提示、错误验证码反馈。 (Done: 2026-01-09)

### 1.2 咨询模块 (Consultation/Chat)
- [x] **会话管理**：历史会话列表分页/排序、创建新会话（强制关联档案）、删除会话。 (Done: 2026-01-09)
- [x] **对话窗口**：
    - [x] **SSE 流式渲染**：分块数据合并、Markdown 实时解析（标题、加粗、列表）。 (Done: 2026-01-09)
    - [x] **自动滚动**：新消息进入时视口平滑置底。 (Done: 2026-01-09)
    - [x] **状态感知**：发送中禁用输入框、解析中的 Loading 动画。 (Done: 2026-01-09)
    - [ ] **脚注交互**：点击 AI 回复中的引用编号弹出原文。 (Pending)

### 1.3 命理排盘模块 (Bazi Chart)
- [x] **档案切换**：Sticky 顶部菜单，切换后立即触发重排动画。 (Done: 2026-01-09)
- [x] **核心展示**：四柱（干、支、十神、藏干、纳音）的五行颜色匹配（木绿、火红、土黄、金灰、水蓝）。 (Done: 2026-01-09)
- [x] **运程下钻**：
    - [x] **大运**：各阶段起运年龄展示、点击展开流年。 (Done: 2026-01-09)
    - [x] **流年**：10 年网格展示、选中高亮。 (Done: 2026-01-09)
    - [x] **流月**：Popup/Drawer 弹出 12 流月干支，背景半透明遮罩。 (Done: 2026-01-09)

### 1.4 个人中心与设置 (Me/Settings)
- [x] **资料预览**：头像（Initials）、昵称、UID 展示。 (Done: 2026-01-09)
- [x] **档案 CRUD**：
    - [x] **地点搜索联动**：基于 `latlng.json` 的递归模糊搜索、经纬度自动回填。 (Done: 2026-01-09)
    - [x] **日期选择**：Datetime-local 兼容性、秒级精度。 (Done: 2026-01-09)
- [x] **系统设置**：
    - [x] **回答模式切换**：普通/专业模式的持久化（PATCH 请求）。 (Done: 2026-01-09)
    - [x] **上下文深度**：Range Slider 滑块控制，数值实时显示。 (Done: 2026-01-09)

---

## 2. 隐蔽问题专项测试 (Edge Cases & Hidden Bugs)

传统的流程测试难以发现的隐蔽 Bug，需通过以下“压力/边缘”测试来捕捉。

### 2.1 状态同步与一致性隐患
- [x] **隐蔽问题 1：配置更新滞后**。 (Done: 2026-01-09)
- [x] **隐蔽问题 2：路由刷新丢失状态**。 (Done: 2026-01-09)

### 2.2 算法与地理边界隐患
- [x] **隐蔽问题 3：极端时差与真太阳时**。 (Done: 2026-01-09 - 验证了喀什 vs 北京的 3 小时偏移)
- [x] **隐蔽问题 4：子时交界点逻辑**。 (Done: 2026-01-09 - 验证了 Sect 1 vs Sect 2 的日柱切换)

### 2.3 性能与并发隐患
- [x] **隐蔽问题 5：SSE 连接堆积**。 (Done: 2026-01-09)
- [x] **隐蔽问题 6：长对话摘要断层**。 (Done: 2026-01-09)

---

## 3. 测试工具集建议

| 工具 | 用途 |
| :--- | :--- |
| **Playwright** | 模拟点击、搜索联动、刷新测试、移动端分辨率模拟。 |
| **F12 Network** | 监控 SSE 数据块（text/event-stream）、Token 认证头检查。 |
| **PostgreSQL CLI** | 校验 `lat/lng` 存储精度（保留 4 位小数）。 |
| **Docker Stats** | 监控在高频 RAG 检索时后端的 CPU/内存波动。 |

---

## 4. 验收标记 (Done)

- [x] **D1: 前端三 Tab 基础功能全覆盖** (2026-01-09)
- [x] **D2: 运程三级钻取逻辑验证** (2026-01-09)
- [x] **D3: 地点搜索 Debounce 与数据回填验证** (2026-01-09)
- [x] **D4: 极端地理位置真太阳时校验** (2026-01-09)
- [x] **D5: 算法偏好（子时切换）实时生效性验证** (2026-01-09)
- [ ] **B1: 高频对话下摘要节点触发稳定性** (Pending)
